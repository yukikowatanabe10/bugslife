<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
<th:block layout:fragment="content">
  <h1 th:if="${category.id == null}">カテゴリー登録</h1>
  <h1 th:if="${category.id != null}">カテゴリー編集</h1>
  <hr />
  <form id="category-form" th:action="@{/categories}" th:method="@{${category.id == null} ? 'post' : 'put'}"
    th:object="${category}">
    <input type="hidden" th:field="*{id}" />

    <div class="form-group">
      <label for="code">コード</label>
      <input id="code" name="code" type="text" class="form-control" th:field="*{code}" required/>
    </div>
    <div class="form-group">
      <label for="name">名前</label>
      <input id="name" name="name" type="text" class="form-control" th:field="*{name}" required maxlength="20"/>
    </div>
    <div class="form-group">
      <label for="display_order">表示順</label>
      <input id="display_order" name="display_order" type="text" class="form-control" th:field="*{displayOrder}" />
    </div>
    <div class="form-group">
      <label>説明</label>
      <textarea class="form-control" th:field="*{description}" maxlength="300"></textarea>
    </div>
    <div id="error-message" style="color: red;"></div>
    <input id="submit" type="submit" class="btn btn-success" value="保存">
    <a th:href="@{/categories}" class="btn btn-default btn-secondary">戻る</a>
  </form>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script>
    $(document).ready(function () {
  $("#category-form").on("submit", function (event) {
    if (!validateForm()) {
      event.preventDefault();
      console.log("form validation failed");
    }
  });

  function validateForm() {
    var isValid = true;
    $(".form-control").each(function () {
      let id = $(this).attr("id");

      // codeのバリデーション
      if (id === "code") {
        let code = $(this).val();
        if (code === "" || !isPatternValid(code)) {
          $(this).addClass("is-invalid");
          isValid = false;
        } else {
          $(this).removeClass("is-invalid");
        }
        console.log(!isPatternValid(code));
      }

      // nameのバリデーション
      if (id === "name") {
        let name = $(this).val();
        if (name === "" || name.length >= 20) {
          $(this).addClass("is-invalid");
          isValid = false;
        } else {
          $(this).removeClass("is-invalid");
        }
        console.log(name.length);
      }

      // desplay_orderのバリデーション
      if (id === "display_order") {
        let displayOrder = $(this).val();
        if (displayOrder === "" || displayOrder < 0 || displayOrder > 999) {
          $(this).addClass("is-invalid");
          isValid = false;
        } else {
          $(this).removeClass("is-invalid");
        }
      }
    });
    return isValid;
  }

  function isPatternValid(code) {
    let pattern = /^([A-Z]{3}-[0-9]{3})$/;
    return pattern.test(code);
  }
});

  </script>
</th:block>

</html>
